#!/bin/bash
#
# Determines prep status of a given node or all nodes via -a
#
# Arguments:
# -n="%NODE% Get status of a specific node
# -a Get status of all nodes in prep.conf
#

sourceconf "$PREP_CONF"

function _prep_status() {

    ALL="0"

    for i in "$@"
        do
        case $i in
            -a)
            ALL="1"
            ;;
            "-n="*)
            HOST="${i#*=}"
            ;;
            *)
            # unknown option
            ;;
        esac
    done


    if [ "$ALL" == "1" ]; then
        MYHOSTS="$NODES"
    else
        MYHOSTS="$HOST"
    end if
    if [ "$MYHOSTS" == "" ]; then
        @go.log FATAL "Must provide a host to connect and update status on via -n= or specify -a for all nodes"
    fi

    for HOST in $MYHOSTS; do
        TESTVAL=""
        TESTVAL=$(ssh -i ${OUT_KEY} ${IUSER}@${HOST} "hostname")
        if [ "$TESTVAL" != "" ]; then
            HOSTUP="true"
            SYS_TYPE=$(ssh -i ${OUT_KEY} ${IUSER}@${HOST} "/home/${IUSER}/system_type.sh")
            TESTVAL=""
            TESTVAL=$(ssh -i ${OUT_KEY} ${IUSER}@${HOST} "sudo whoami")
            if [ "$TESTVAL" == "root" ]; then
                SUDOPRIV="true"
                TESTVAL=""
                TESTVAL=$(ssh -i ${OUT_KEY} ${IUSER}@${HOST} "sudo docker info 2> /dev/null")
                if [ "$TESTVAL" != "" ]; then
                    DOCKER="true"
                else
                    DOCKER="false"
                fi
            else
                SUDOPRIV="false"
                DOCKER="false"
            fi
        else
            HOSTUP="false"
            SUDOPRIV="false"
            DOCKER="false"
        fi
        @go.log INFO "Prep Status for $HOST - SYS_TYPE: $SYS_TYPE -  UP: $HOSTUP - SUDO: $SUDOPRIV - DOCKER: $DOCKER"
    done
}

_prep_status "$@"
